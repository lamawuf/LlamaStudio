<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LlamaStudio - Lead Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0f0f0f',
                            800: '#1a1a1a',
                            700: '#2a2a2a',
                            600: '#3a3a3a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.2);
        }
        .status-waiting { background: #3b82f6; }
        .status-callback { background: #f59e0b; }
        .status-rejected { background: #ef4444; }
        .status-working { background: #10b981; }
        .status-completed { background: #8b5cf6; }
    </style>
</head>
<body class="bg-dark-900 text-white min-h-screen">
    <!-- Header -->
    <header class="border-b border-dark-700 px-6 py-4">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center gap-3">
                <span class="text-3xl">ü¶ô</span>
                <h1 class="text-2xl font-bold gradient-text">LlamaStudio</h1>
            </div>
            <div class="text-gray-400 text-sm">
                Lead Manager v1.0
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="bg-dark-800 rounded-xl p-4 border border-dark-700 card-hover transition-all">
                <div class="text-gray-400 text-sm mb-1">–í—Å–µ–≥–æ</div>
                <div class="text-3xl font-bold" id="stat-total">-</div>
            </div>
            <div class="bg-dark-800 rounded-xl p-4 border border-blue-500/30 card-hover transition-all">
                <div class="text-blue-400 text-sm mb-1">–ñ–¥—ë—Ç –∑–≤–æ–Ω–∫–∞</div>
                <div class="text-3xl font-bold text-blue-400" id="stat-waiting">-</div>
            </div>
            <div class="bg-dark-800 rounded-xl p-4 border border-yellow-500/30 card-hover transition-all">
                <div class="text-yellow-400 text-sm mb-1">–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</div>
                <div class="text-3xl font-bold text-yellow-400" id="stat-callback">-</div>
            </div>
            <div class="bg-dark-800 rounded-xl p-4 border border-red-500/30 card-hover transition-all">
                <div class="text-red-400 text-sm mb-1">–û—Ç–∫–∞–∑</div>
                <div class="text-3xl font-bold text-red-400" id="stat-rejected">-</div>
            </div>
            <div class="bg-dark-800 rounded-xl p-4 border border-green-500/30 card-hover transition-all">
                <div class="text-green-400 text-sm mb-1">–†–∞–±–æ—Ç–∞–µ–º</div>
                <div class="text-3xl font-bold text-green-400" id="stat-working">-</div>
            </div>
            <div class="bg-dark-800 rounded-xl p-4 border border-purple-500/30 card-hover transition-all">
                <div class="text-purple-400 text-sm mb-1">–í—ã–ø–æ–ª–Ω–∏–ª–∏</div>
                <div class="text-3xl font-bold text-purple-400" id="stat-completed">-</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-dark-800 rounded-xl p-4 mb-6 border border-dark-700">
            <div class="flex flex-wrap gap-4 items-center">
                <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫..."
                    class="bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 w-full md:w-48 focus:outline-none focus:border-purple-500">

                <select id="filter-city" class="bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500">
                    <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                </select>

                <select id="filter-category" class="bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                </select>

                <select id="filter-status" class="bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="waiting">–ñ–¥—ë—Ç –∑–≤–æ–Ω–∫–∞</option>
                    <option value="callback">–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</option>
                    <option value="rejected">–û—Ç–∫–∞–∑</option>
                    <option value="working">–†–∞–±–æ—Ç–∞–µ–º</option>
                    <option value="completed">–í—ã–ø–æ–ª–Ω–∏–ª–∏</option>
                </select>

                <button onclick="loadAll()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition-colors">
                    –û–±–Ω–æ–≤–∏—Ç—å
                </button>

                <button onclick="exportContacts()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                    üì± –≠–∫—Å–ø–æ—Ä—Ç –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã
                </button>
            </div>
        </div>

        <!-- Leads Table -->
        <div class="bg-dark-800 rounded-xl border border-dark-700 overflow-hidden">
            <table class="w-full">
                <thead class="bg-dark-700">
                    <tr>
                        <th class="text-left p-4 text-gray-400 font-medium">–ö–æ–º–ø–∞–Ω–∏—è</th>
                        <th class="text-left p-4 text-gray-400 font-medium">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th class="text-left p-4 text-gray-400 font-medium">–°–æ—Ü—Å–µ—Ç–∏</th>
                        <th class="text-left p-4 text-gray-400 font-medium">–°—Ç–∞—Ç—É—Å</th>
                        <th class="text-left p-4 text-gray-400 font-medium">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="leads-table">
                    <tr><td colspan="5" class="p-8 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
        <div class="bg-dark-800 rounded-xl p-6 w-full max-w-md mx-4 border border-dark-600">
            <h3 class="text-xl font-bold mb-4" id="modal-title">–û–±–Ω–æ–≤–∏—Ç—å –ª–∏–¥</h3>
            <input type="hidden" id="modal-lead-id">

            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-2">–°—Ç–∞—Ç—É—Å</label>
                <select id="modal-status" class="bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 w-full">
                    <option value="waiting">–ñ–¥—ë—Ç –∑–≤–æ–Ω–∫–∞</option>
                    <option value="callback">–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</option>
                    <option value="rejected">–û—Ç–∫–∞–∑</option>
                    <option value="working">–†–∞–±–æ—Ç–∞–µ–º (–∫–ª–∏–µ–Ω—Ç)</option>
                    <option value="completed">–í—ã–ø–æ–ª–Ω–∏–ª–∏ (–∫–ª–∏–µ–Ω—Ç)</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–≤–æ–Ω–∫–∞</label>
                <select id="modal-result" class="bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 w-full">
                    <option value="">-</option>
                    <option value="no_answer">–ù–µ –æ—Ç–≤–µ—Ç–∏–ª</option>
                    <option value="callback">–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</option>
                    <option value="thinking">–î—É–º–∞–µ—Ç</option>
                    <option value="send_price">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ü–µ–Ω—ã</option>
                    <option value="meeting">–ù–∞–∑–Ω–∞—á–µ–Ω–∞ –≤—Å—Ç—Ä–µ—á–∞</option>
                    <option value="deal">–°–¥–µ–ª–∫–∞</option>
                    <option value="not_interested">–ù–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ</option>
                    <option value="has_site">–£–∂–µ –µ—Å—Ç—å —Å–∞–π—Ç</option>
                </select>
            </div>

            <div class="mb-6">
                <label class="block text-gray-400 text-sm mb-2">–ó–∞–º–µ—Ç–∫–∏</label>
                <textarea id="modal-notes" rows="3" class="bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 w-full resize-none"></textarea>
            </div>

            <div class="flex gap-3">
                <button onclick="saveModal()" class="flex-1 bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition-colors">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button onclick="closeModal()" class="flex-1 bg-dark-600 hover:bg-dark-500 px-4 py-2 rounded-lg transition-colors">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <script>
        // Load filters
        async function loadFilters() {
            // Cities
            const citiesRes = await fetch('/api/cities');
            const cities = await citiesRes.json();
            const citySelect = document.getElementById('filter-city');
            cities.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = `${c.name} (${c.count})`;
                citySelect.appendChild(opt);
            });

            // Categories
            const catRes = await fetch('/api/categories');
            const categories = await catRes.json();
            const catSelect = document.getElementById('filter-category');
            categories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = `${c.name} (${c.count})`;
                catSelect.appendChild(opt);
            });
        }

        // Load stats
        async function loadStats() {
            const cityId = document.getElementById('filter-city').value;
            const categoryId = document.getElementById('filter-category').value;

            let url = '/api/stats?';
            if (cityId) url += `city_id=${cityId}&`;
            if (categoryId) url += `category_id=${categoryId}&`;

            const res = await fetch(url);
            const data = await res.json();
            document.getElementById('stat-total').textContent = data.total;
            document.getElementById('stat-waiting').textContent = data.waiting;
            document.getElementById('stat-callback').textContent = data.callback;
            document.getElementById('stat-rejected').textContent = data.rejected;
            document.getElementById('stat-working').textContent = data.working;
            document.getElementById('stat-completed').textContent = data.completed;
        }

        // Load leads
        async function loadLeads() {
            const search = document.getElementById('search').value;
            const status = document.getElementById('filter-status').value;
            const cityId = document.getElementById('filter-city').value;
            const categoryId = document.getElementById('filter-category').value;

            let url = '/api/leads?';
            if (search) url += `search=${encodeURIComponent(search)}&`;
            if (status) url += `status=${status}&`;
            if (cityId) url += `city_id=${cityId}&`;
            if (categoryId) url += `category_id=${categoryId}&`;

            const res = await fetch(url);
            const leads = await res.json();

            const tbody = document.getElementById('leads-table');

            if (leads.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">–ù–µ—Ç –ª–∏–¥–æ–≤</td></tr>';
                return;
            }

            tbody.innerHTML = leads.map(lead => `
                <tr class="border-t border-dark-700 hover:bg-dark-700/50 transition-colors">
                    <td class="p-4">
                        <div class="font-medium">${lead.name}</div>
                        ${lead.url_2gis ? `<a href="${lead.url_2gis}" target="_blank" class="text-sm text-purple-400 hover:underline">üìç 2GIS</a>` : ''}
                    </td>
                    <td class="p-4">${formatPhones(lead.phones)}</td>
                    <td class="p-4">${formatSocials(lead.social, lead.phones)}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded text-xs font-medium status-${lead.status}">
                            ${getStatusLabel(lead.status)}
                        </span>
                    </td>
                    <td class="p-4">
                        <button onclick="openModal(${lead.id}, '${lead.status}', '${lead.result || ''}', '${(lead.notes || '').replace(/'/g, "\\'")}')"
                            class="bg-dark-600 hover:bg-dark-500 px-3 py-1 rounded text-sm transition-colors">
                            –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusLabel(status) {
            const labels = {
                'waiting': '–ñ–¥—ë—Ç –∑–≤–æ–Ω–∫–∞',
                'callback': '–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å',
                'rejected': '–û—Ç–∫–∞–∑',
                'working': '–†–∞–±–æ—Ç–∞–µ–º',
                'completed': '–í—ã–ø–æ–ª–Ω–∏–ª–∏'
            };
            return labels[status] || status;
        }

        function formatPhones(phones) {
            if (!phones) return '<span class="text-gray-500">-</span>';
            return phones.split(',').map(p => p.trim()).filter(p => p).map(phone =>
                `<a href="tel:${phone}" class="text-blue-400 hover:underline font-mono block" onclick="event.stopPropagation(); navigator.clipboard.writeText('${phone}')">${phone}</a>`
            ).join('');
        }

        function loadAll() {
            loadStats();
            loadLeads();
        }

        function formatSocials(social, phones) {
            if (!social) return '<span class="text-gray-500">-</span>';

            const firstPhone = phones ? phones.split(',')[0].trim() : '';
            const cleanPhone = firstPhone.replace(/[^0-9]/g, '');
            const links = [];

            if (social.includes('WhatsApp')) {
                links.push(`<a href="https://wa.me/${cleanPhone}" target="_blank" class="text-green-400 hover:underline">üí¨ WhatsApp</a>`);
            }
            if (social.includes('Telegram')) {
                links.push(`<a href="https://t.me/+${cleanPhone}" target="_blank" class="text-blue-400 hover:underline">‚úàÔ∏è Telegram</a>`);
            }
            if (social.includes('VK')) {
                links.push(`<span class="text-blue-300">VK</span>`);
            }
            if (social.includes('YouTube')) {
                links.push(`<span class="text-red-400">YouTube</span>`);
            }
            if (social.includes('Instagram')) {
                links.push(`<span class="text-pink-400">Instagram</span>`);
            }

            return links.length > 0 ? links.join(' ') : `<span class="text-gray-400">${social}</span>`;
        }

        // Modal
        function openModal(id, status, result, notes) {
            document.getElementById('modal-lead-id').value = id;
            document.getElementById('modal-status').value = status;
            document.getElementById('modal-result').value = result;
            document.getElementById('modal-notes').value = notes;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        }

        async function saveModal() {
            const id = document.getElementById('modal-lead-id').value;
            const status = document.getElementById('modal-status').value;
            const result = document.getElementById('modal-result').value;
            const notes = document.getElementById('modal-notes').value;

            await fetch(`/api/leads/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status, result, notes })
            });

            closeModal();
            loadStats();
            loadLeads();
        }

        // Event listeners
        document.getElementById('search').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') loadAll();
        });
        document.getElementById('filter-status').addEventListener('change', loadAll);
        document.getElementById('filter-city').addEventListener('change', loadAll);
        document.getElementById('filter-category').addEventListener('change', loadAll);

        // Export contacts to vCard
        function exportContacts() {
            const cityId = document.getElementById('filter-city').value;
            const categoryId = document.getElementById('filter-category').value;
            const status = document.getElementById('filter-status').value;

            let url = '/api/export/vcard?';
            if (cityId) url += `city_id=${cityId}&`;
            if (categoryId) url += `category_id=${categoryId}&`;
            if (status) url += `status=${status}&`;

            window.location.href = url;
        }

        // Init
        loadFilters();
        loadStats();
        loadLeads();
    </script>
</body>
</html>
